<script type="module">
  import * as pdfjsLib from './build/pdf.mjs';

  // Parse ?file= URL
  const urlParams = new URLSearchParams(window.location.search);
  const fileUrl = urlParams.get('file');

  if (!fileUrl) {
    document.getElementById('pdfViewer').textContent = 'Missing ?file= URL';
    throw new Error('Missing file parameter');
  }

  // Setup worker
  pdfjsLib.GlobalWorkerOptions.workerSrc = './build/pdf.worker.mjs';

  // Extract and display title from presigned URL
  function extractFileNameFromPresignedUrl(url) {
    try {
      const parsed = new URL(url);
      const fileKey = parsed.searchParams.get('fileKey');
      if (!fileKey) return null;

      const pathParts = fileKey.split('/');
      const fileName = pathParts[pathParts.length - 1];
      const baseName = decodeURIComponent(fileName.replace(/\.[^/.]+$/, ''));
      return baseName;
    } catch (e) {
      console.error('Failed to extract title:', e);
      return null;
    }
  }

  const title = extractFileNameFromPresignedUrl(fileUrl);
  if (title) {
    document.getElementById('pdf-title').textContent = title;
  }

  // Dynamic scale for different screen sizes
  const screenWidth = window.innerWidth;
  let scale = 1.3;
  if (screenWidth < 768) {
    scale = 0.9; // Mobile
  } else if (screenWidth < 1024) {
    scale = 1.1; // Tablet
  }

  // Load and render PDF
  const loadingTask = pdfjsLib.getDocument(fileUrl);
  loadingTask.promise.then(pdf => {
    const container = document.getElementById('pdfViewer');

    for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
      pdf.getPage(pageNum).then(page => {
        const viewport = page.getViewport({ scale });
        const outputScale = window.devicePixelRatio || 1;

        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');

        canvas.width = viewport.width * outputScale;
        canvas.height = viewport.height * outputScale;
        canvas.style.width = `${viewport.width}px`;
        canvas.style.height = `${viewport.height}px`;

        context.setTransform(outputScale, 0, 0, outputScale, 0, 0);

        container.appendChild(canvas);
        page.render({ canvasContext: context, viewport });
      });
    }
  }).catch(error => {
    console.error('Error loading PDF:', error);
    document.getElementById('pdfViewer').textContent = 'Error loading PDF.';
  });
</script>
