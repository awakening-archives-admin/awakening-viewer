<script type="module">
  import * as pdfjsLib from './build/pdf.mjs';

  const urlParams = new URLSearchParams(window.location.search);
  const fileKey = urlParams.get('fileKey');

  if (!fileKey) {
    document.getElementById('pdfViewer').textContent = 'Missing ?fileKey= URL';
    throw new Error('Missing fileKey parameter');
  }

  // Setup worker
  pdfjsLib.GlobalWorkerOptions.workerSrc = './build/pdf.worker.mjs';

  // Title Extraction
  function extractFileNameFromFileKey(key) {
    try {
      const pathParts = key.split('/');
      const fileName = pathParts[pathParts.length - 1];
      const baseName = decodeURIComponent(fileName.replace(/\.[^/.]+$/, ''));
      return baseName;
    } catch (e) {
      console.error('Failed to extract title:', e);
      return null;
    }
  }

  const title = extractFileNameFromFileKey(fileKey);
  if (title) {
    document.getElementById('pdf-title').textContent = title;
  }

  // --- Smart Scale for Screen Size ---
  function getOptimalScale() {
    const screenWidth = window.innerWidth;
    if (screenWidth < 600) return 0.8;
    if (screenWidth < 900) return 1.1;
    return 1.5; // default for desktop
  }

  // Fetch presigned URL
  const apiUrl = 'https://8a73bzipp6.execute-api.us-west-1.amazonaws.com/GeneratePresignedUrl';
  const fetchUrl = `${apiUrl}?fileKey=${encodeURIComponent(fileKey)}`;

  fetch(fetchUrl)
    .then(response => response.json())
    .then(data => {
      const presignedUrl = data.url;
      return pdfjsLib.getDocument(presignedUrl).promise;
    })
    .then(pdf => {
      const container = document.getElementById('pdfViewer');

      for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
        pdf.getPage(pageNum).then(page => {
          const canvas = document.createElement('canvas');
          canvas.style.display = 'block';
          canvas.style.margin = '0 auto';
          canvas.style.maxWidth = '100%';
          container.appendChild(canvas);

          const context = canvas.getContext('2d');
          const viewport = page.getViewport({ scale: getOptimalScale() });

          canvas.width = viewport.width;
          canvas.height = viewport.height;

          page.render({ canvasContext: context, viewport });
        });
      }
    })
    .catch(error => {
      console.error('Error loading PDF:', error);
      document.getElementById('pdfViewer').textContent = 'Error loading PDF.';
    });
</script>
